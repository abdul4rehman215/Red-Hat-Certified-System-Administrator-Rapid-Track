==============================
Lab 27: Configuring and Securing SSH
==============================

# -----------------------------------
# 1. Verify OpenSSH Server Installed
# -----------------------------------

$ rpm -qa | grep openssh-server
openssh-server-7.4p1-23.el7_9.x86_64

$ systemctl status sshd
● sshd.service - OpenSSH server daemon
   Loaded: loaded (/usr/lib/systemd/system/sshd.service; enabled; vendor preset: enabled)
   Active: active (running) since Mon 2026-02-23 14:18:42 UTC; 49min ago
     Docs: man:sshd(8)
           man:sshd_config(5)
 Main PID: 1086 (sshd)
   CGroup: /system.slice/sshd.service
           └─1086 /usr/sbin/sshd -D

Feb 23 14:18:42 ip-172-31-18-204 systemd[1]: Starting OpenSSH server daemon...
Feb 23 14:18:42 ip-172-31-18-204 sshd[1086]: Server listening on 0.0.0.0 port 22.
Feb 23 14:18:42 ip-172-31-18-204 sshd[1086]: Server listening on :: port 22.
Feb 23 14:18:42 ip-172-31-18-204 systemd[1]: Started OpenSSH server daemon.

$ sudo yum install openssh-server -y
Package openssh-server-7.4p1-23.el7_9.x86_64 already installed and latest version
Nothing to do


# -----------------------------------
# 2. Enable and Restart SSH Service
# -----------------------------------

$ sudo systemctl start sshd

$ sudo systemctl enable sshd
Created symlink from /etc/systemd/system/multi-user.target.wants/sshd.service to /usr/lib/systemd/system/sshd.service.

$ sudo systemctl status sshd
● sshd.service - OpenSSH server daemon
   Loaded: loaded (/usr/lib/systemd/system/sshd.service; enabled; vendor preset: enabled)
   Active: active (running) since Mon 2026-02-23 14:18:42 UTC; 51min ago
   Main PID: 1086 (sshd)


# -----------------------------------
# 3. Verify SSH Security Configuration
# -----------------------------------

$ sudo egrep -n '^(Port|PermitRootLogin|PubkeyAuthentication|PasswordAuthentication|PermitEmptyPasswords|MaxAuthTries|ClientAliveInterval|ClientAliveCountMax)\b' /etc/ssh/sshd_config
17:Port 22
38:PermitRootLogin no
58:PubkeyAuthentication yes
66:PasswordAuthentication yes
69:PermitEmptyPasswords no
71:MaxAuthTries 3
78:ClientAliveInterval 300
79:ClientAliveCountMax 2

$ sudo sshd -t
(no output = syntax OK)

$ sudo systemctl restart sshd


# -----------------------------------
# 4. Firewall Configuration
# -----------------------------------

$ sudo firewall-cmd --state
running

$ sudo firewall-cmd --permanent --add-service=ssh
success

$ sudo firewall-cmd --permanent --add-port=22/tcp
success

$ sudo firewall-cmd --reload
success

$ sudo firewall-cmd --list-services
dhcpv6-client ssh


# -----------------------------------
# 5. Create Test User
# -----------------------------------

$ sudo useradd testuser

$ sudo passwd testuser
Changing password for user testuser.
New password:
Retype new password:
passwd: all authentication tokens updated successfully.


# -----------------------------------
# 6. Local SSH Test
# -----------------------------------

$ ssh testuser@localhost
The authenticity of host 'localhost (::1)' can't be established.
ECDSA key fingerprint is SHA256:3a6P6rV8h0GfHq6mY3f7Vv3n3+u6s9yQm4xCqGd1PpE.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'localhost' (ECDSA) to the list of known hosts.
testuser@localhost's password:
Last login: Mon Feb 23 15:13:58 2026 from ::1
[testuser@ip-172-31-18-204 ~]$

$ whoami
testuser

$ hostname
ip-172-31-18-204

$ exit
logout
Connection to localhost closed.


# -----------------------------------
# 7. Remote SSH Test (VM2 → VM1)
# -----------------------------------

$ ssh testuser@172.31.18.204
The authenticity of host '172.31.18.204' can't be established.
ECDSA key fingerprint is SHA256:3a6P6rV8h0GfHq6mY3f7Vv3n3+u6s9yQm4xCqGd1PpE.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '172.31.18.204' (ECDSA) to the list of known hosts.
testuser@172.31.18.204's password:
Last login: Mon Feb 23 15:15:06 2026 from 172.31.16.73
[testuser@ip-172-31-18-204 ~]$

$ exit
logout
Connection to 172.31.18.204 closed.


# -----------------------------------
# 8. SSH Verbose Debug
# -----------------------------------

$ ssh -v testuser@172.31.18.204
OpenSSH_7.4p1, OpenSSL 1.0.2k-fips
debug1: Connecting to 172.31.18.204 port 22.
debug1: Connection established.
debug1: Authenticating to 172.31.18.204:22 as 'testuser'
debug1: Authentications that can continue: publickey,password
testuser@172.31.18.204's password:
debug1: Authentication succeeded (password).


# -----------------------------------
# 9. Generate SSH Key (VM2)
# -----------------------------------

$ ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
Generating public/private rsa key pair.
Your identification has been saved in /home/centos/.ssh/id_rsa.
Your public key has been saved in /home/centos/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:6o0mE0fF5VJ0bQq9iHh3+7nQ4m0cD3h9qfE1nq6nHq8 your_email@example.com


$ ls -la ~/.ssh/
drwx------ 2 centos centos 4096 Feb 23 15:20 .
-rw------- 1 centos centos 3381 Feb 23 15:20 id_rsa
-rw-r--r-- 1 centos centos 741 Feb 23 15:20 id_rsa.pub
-rw-r--r-- 1 centos centos 444 Feb 23 15:15 known_hosts


# -----------------------------------
# 10. Copy Public Key to Server
# -----------------------------------

$ ssh-copy-id testuser@172.31.18.204
Number of key(s) added: 1


# -----------------------------------
# 11. Key-Based Login Test
# -----------------------------------

$ ssh testuser@172.31.18.204
Last login: Mon Feb 23 15:16:12 2026
[testuser@ip-172-31-18-204 ~]$

(no password prompt shown)


# -----------------------------------
# 12. Verify Accepted Public Key in Logs
# -----------------------------------

$ sudo journalctl -u sshd | grep "Accepted publickey" | tail -3
Feb 23 15:21:14 ip-172-31-18-204 sshd[2597]: Accepted publickey for testuser from 172.31.16.73 port 50122 ssh2: RSA SHA256:6o0mE0fF5VJ0bQq9iHh3+7nQ4m0cD3h9qfE1nq6nHq8


# -----------------------------------
# 13. Disable Password Authentication
# -----------------------------------

$ sudo sshd -t
(no output)

$ sudo systemctl restart sshd

$ ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no testuser@172.31.18.204
Permission denied (publickey,gssapi-keyex,gssapi-with-mic).


# -----------------------------------
# 14. Verify SSH Listening Port
# -----------------------------------

$ sudo ss -tuln | grep :22
LISTEN 0 128 0.0.0.0:22 0.0.0.0:*
LISTEN 0 128 [::]:22 [::]:*


# -----------------------------------
# 15. Final SSH Verification
# -----------------------------------

$ ssh testuser@172.31.18.204 "whoami && hostname"
testuser
ip-172-31-18-204


==============================
Lab 27 Completed Successfully
==============================
